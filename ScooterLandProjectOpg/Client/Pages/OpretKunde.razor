@page "/opretkunde"
@using ScooterLandProjectOpg.Shared.Models
@inject HttpClient Http

<h3>Opret Kunde</h3>


    <!-- Sektion: Kundeoplysninger -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5>Kundeoplysninger</h5>
        </div>
        <div class="card-body">
            <EditForm Model="nyKunde" OnValidSubmit="VisBekræftelsesDialog">
                <DataAnnotationsValidator />
                <div class="mb-3">
                    <label for="navn" class="form-label">Navn:</label>
                    <InputText @bind-Value="nyKunde.Navn" id="navn" class="form-control" placeholder="Indtast navn" />
                    <ValidationMessage For="@(() => nyKunde.Navn)" />
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email:</label>
                    <InputText @bind-Value="nyKunde.Email" id="email" class="form-control" placeholder="Indtast email" />
                    <ValidationMessage For="@(() => nyKunde.Email)" />
                </div>
                <div class="mb-3">
                    <label for="telefon" class="form-label">Telefon:</label>
                    <InputNumber @bind-Value="nyKunde.Telefonnummer" id="telefon" class="form-control" placeholder="Indtast telefonnummer" />
                    <ValidationMessage For="@(() => nyKunde.Telefonnummer)" />
                </div>
                <div class="mb-3">
                    <label for="adresse" class="form-label">Adresse:</label>
                    <InputText @bind-Value="nyKunde.Adresse" id="adresse" class="form-control" placeholder="Indtast adresse" />
                    <ValidationMessage For="@(() => nyKunde.Adresse)" />
                </div>
            </EditForm>
        </div>
    </div>

    <EditForm Model="nyKunde" OnValidSubmit="VisBekræftelsesDialog">
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5>Tilføj Scootere</h5>
            </div>
            <div class="card-body">
                @if (scootere.Any())
                {
                    <table class="table table-striped">
                        <thead class="table-light">
                            <tr>
                                <th>Mærke</th>
                                <th>Model</th>
                                <th>Registreringsnummer</th>
                                <th>Produktionsår</th>
                                <th>Handling</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var scooter in scootere)
                            {
                                <tr>
                                    <td><InputText @bind-Value="scooter.Maerke" class="form-control" /></td>
                                    <td><InputText @bind-Value="scooter.Model" class="form-control" /></td>
                                    <td>
                                        <InputText @bind-Value="scooter.RegistreringsNummer" class="form-control" />
                                        <ValidationMessage For="@(() => scooter.RegistreringsNummer)" />
                                    </td>
                                    <td>
                                        <InputNumber @bind-Value="scooter.ProduktionsAar" class="form-control" />
                                        <ValidationMessage For="@(() => scooter.ProduktionsAar)" />
                                    </td>
                                    <td>
                                        <button class="btn btn-danger" @onclick="() => FjernScooter(scooter)">
                                            <i class="bi bi-trash"></i> Fjern
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-muted">Ingen scootere tilføjet endnu.</p>
                }

                <div class="d-flex mt-3">
                    <button type="button" class="btn btn-secondary me-2" @onclick="TilføjScooter">
                        <i class="bi bi-plus-circle"></i> Tilføj Scooter
                    </button>
                    <button type="submit" class="btn btn-primary ms-2">
                        <i class="bi bi-save"></i> Opret Kunde
                    </button>
                </div>
            </div>
        </div>
    </EditForm>


<!-- Bekræftelsesdialog -->
@if (visBekræftelse)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0, 0, 0, 0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Bekræft Oprettelse</h5>
                    <button type="button" class="btn-close" @onclick="AnnullerBekræftelse"></button>
                </div>
                <div class="modal-body">
                    <p>Er du sikker på, at du vil oprette følgende kunde?</p>
                    <ul>
                        <li><strong>Navn:</strong> @nyKunde.Navn</li>
                        <li><strong>Email:</strong> @nyKunde.Email</li>
                        <li><strong>Telefon:</strong> @nyKunde.Telefonnummer</li>
                        <li><strong>Adresse:</strong> @nyKunde.Adresse</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" @onclick="OpretEnKunde">Ja, opret</button>
                    <button class="btn btn-secondary" @onclick="AnnullerBekræftelse">Annuller</button>
                </div>
            </div>
        </div>
    </div>
}

@if (fejlbesked != null)
{
    <div class="alert alert-danger mt-3">@fejlbesked</div>
}

@if (succesbesked != null)
{
    <div class="alert alert-success mt-3">@succesbesked</div>
}
<div class="d-flex justify-content-center align-items-center position-relative mt-4" style="height: 150px;">
    <div class="alert alert-light border rounded-3 shadow-sm text-center"
         style="max-width: 600px; width: 90%; padding: 15px; margin-bottom: 0;">
        <h6 class="text-primary fw-bold mb-2">Scooterland</h6>
        <p class="mb-1"><strong>Adresse:</strong> Hovedgade 123, 4000 Roskilde</p>
        <p class="mb-1"><strong>Telefon:</strong> 12 34 56 78</p>
        <p class="mb-1"><strong>Email:</strong> kontakt@scooterland.dk</p>
        <p class="mb-0"><strong>Dags dato:</strong> @DateTime.Now.ToString("dd-MM-yyyy")</p>
    </div>
</div>
@code {
    private Kunde nyKunde = new();
    private List<KundeScooter> scootere = new();
    private bool visBekræftelse = false;
    private string? fejlbesked;
    private string? succesbesked;

    private void TilføjScooter()
    {
        scootere.Add(new KundeScooter());
    }

    private void FjernScooter(KundeScooter scooter)
    {
        scootere.Remove(scooter);
    }

    private void VisBekræftelsesDialog()
    {
        fejlbesked = null;
        succesbesked = null;
        visBekræftelse = true;
    }

    private void AnnullerBekræftelse()
    {
        visBekræftelse = false;
    }

    private async Task OpretEnKunde()
    {
        try
        {
            visBekræftelse = false;
            var response = await Http.PostAsJsonAsync("api/Kunde", nyKunde);

            if (response.IsSuccessStatusCode)
            {
                var oprettetKunde = await response.Content.ReadFromJsonAsync<Kunde>();

                foreach (var scooter in scootere)
                {
                    scooter.KundeId = oprettetKunde.KundeId;
                    await Http.PostAsJsonAsync($"api/KundeScooter/{oprettetKunde.KundeId}/add-scooter", scooter);
                }

                nyKunde = new Kunde();
                scootere.Clear();
                succesbesked = "Kunden og scootere blev oprettet med succes!";
            }
            else
            {
                fejlbesked = "Der opstod en fejl under oprettelse af kunden.";
            }
        }
        catch (Exception ex)
        {
            fejlbesked = $"Fejl: {ex.Message}";
        }
    }
}

@page "/kundekatalog"
@using ScooterLandProjectOpg.Shared.Models
@inject HttpClient Http
@using System.Text.Json
@using ScooterLandProjectOpg.Shared.Enum

@* Opretter en container med top og bundmargen (my-4). *@
<div class="container my-4">
	@* Opretter et korts header med blå baggrund, hvid tekst, og centreret indhold. *@
	<div class="card-header bg-primary text-white text-center">
		@* Viser en titel i kortets header. *@
		<h3 class="card-title">Kunde Katalog</h3>
	</div>

	@* Opretter et form-group-område til søgefelt og knapper, med margin-top og fleksibelt layout. *@
	<div class="form-group mt-3 d-flex">
		@* Tekstboks til søgning, bundet til variablen søgeTekst. *@
		<input id="search" type="text" class="form-control me-2"
			   @bind="søgeTekst"
			   placeholder="Søg på Kunde ID, Navn eller Telefonnummer" />
		@* Knap, der kalder metoden SøgKunder ved klik. *@
		<button class="btn btn-primary me-2" @onclick="SøgKunder">Søg</button>
		@* Knap, der kalder metoden RydSøgning ved klik (nulstiller). *@
		<button class="btn btn-secondary" @onclick="RydSøgning">Ryd</button>
	</div>

	@* Viser en loading-tekst, hvis kunder-listen ikke er hentet endnu. *@
	@if (kunder == null)
	{
		@* Et centreret afsnit med "Loading..."-tekst. *@
		<div class="text-center">
			<p class="text-muted">Loading...</p>
		</div>
	}
	else
	{
		@* Knap til at oprette en ny kunde. *@
		<div class="text-center my-3">
			@* Ved klik på knappen kaldes VisOpretModal, der åbner en modal til oprettelse. *@
			<button class="btn custom-btn" @onclick="VisOpretModal">Opret Kunde</button>
			@* Indlejret CSS, som definerer en specialknap med gradient og hover-effekt. *@
			<style>
				.custom-btn {
					background: linear-gradient(to bottom, #4f81bd, #1f4e79); /* Samme gradient som boksen */
					color: white; /* Tekstfarve */
					border: none; /* Fjern kant */
					border-radius: 25px; /* Afrundede hjørner */
					padding: 10px 20px; /* Størrelse på knappen */
					font-size: 16px; /* Tekststørrelse */
					box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2); /* Skygge */
					transition: all 0.3s ease-in-out; /* Glidende hover-effekt */
				}

					.custom-btn:hover {
						background: linear-gradient(to bottom, #1f4e79, #4f81bd); /* Omvendt gradient på hover */
						transform: scale(1.1); /* Gør knappen lidt større */
						box-shadow: 0px 6px 8px rgba(0, 0, 0, 0.3); /* Mere markant skygge */
					}
			</style>
		</div>

		@* Tabel til visning af kunder, med striber og hover-effekt. *@
		<table class="table table-striped table-hover">
			@* Header-række med primær baggrund. *@
			<thead class="table-primary">
				<tr>
					@* Kolonneoverskrifter for kundedata. *@
					<th>ID</th>
					<th>Navn</th>
					<th>Email</th>
					<th>Telefon</th>
					<th>Adresse</th>
					<th>Scootere</th>
					<th>Handlinger</th>
				</tr>
			</thead>
			@* Tabel-krop, hvor hver kunde vises i sin egen række. *@
			<tbody>
				@if (filtreredeKunder.Any())
				{
					@* Går igennem alle filtrerede kunder. *@
					@foreach (var kunde in filtreredeKunder)
					{
						<tr>
							@* Viser kundens ID. *@
							<td>@kunde.KundeId</td>
							@* Viser kundens navn. *@
							<td>@kunde.Navn</td>
							@* Viser kundens email. *@
							<td>@kunde.Email</td>
							@* Viser kundens telefonnummer. *@
							<td>@kunde.Telefonnummer</td>
							@* Viser kundens adresse. *@
							<td>@kunde.Adresse</td>
							@* Knap til at toggle visning af scootere, kalder ToggleScooterVisning. *@
							<td>
								<button class="btn btn-light shadow-sm text-primary hover-highlight px-3 py-2" @onclick="() => ToggleScooterVisning(kunde.KundeId)">
									<i class="bi bi-eye-fill"></i> Vis Scootere
								</button>
							</td>
							@* Kolonne til diverse handlinger for kunden. *@
							<td>
								<div class="d-flex justify-content-evenly">
									@* Knap til at åbne sidepanelet med kundeoplysninger og ordrer. *@
									<button class="btn btn-primary btn-sm me-2" @onclick="() => ÅbnSidePanel(kunde.KundeId)">Se Ordrer</button>
									@* Knap til at vise modal, der redigerer kunden. *@
									<button class="btn btn-secondary btn-sm me-2" @onclick="() => VisRedigerModal(kunde)">Rediger</button>
									@* Knap til at vise modal for at tilføje en ny scooter til kunden. *@
									<button class="btn btn-info btn-sm" @onclick="() => VisTilføjScooterModal(kunde)">Tilføj Scooter</button>
								</div>
							</td>
						</tr>

						@* Hvis vi har scootere for kunden og dennes ID matcher visScooterKundeId, viser vi en ekstra række med scootere. *@
						@if (kundeScootere.TryGetValue(kunde.KundeId, out var scootere) && visScooterKundeId == kunde.KundeId)
						{
							<tr>
								@* Kolspan sætter, at rækkerne går over alle 7 kolonner. *@
								<td colspan="7" class="bg-light">
									@if (scootere != null && scootere.Any())
									{
										@* Viser en tabel med scootere, hvis der er nogen. *@
										<table class="table table-bordered mt-3">
											@* Tabel-header for scooterinfo. *@
											<thead class="table-secondary">
												<tr>
													<th>Mærke</th>
													<th>Model</th>
													<th>Registreringsnummer</th>
												</tr>
											</thead>
											@* Scooter-information i tabellen. *@
											<tbody>
												@foreach (var scooter in scootere)
												{
													<tr>
														<td>@scooter.Maerke</td>
														<td>@scooter.Model</td>
														<td>@scooter.RegistreringsNummer</td>
													</tr>
												}
											</tbody>
										</table>
									}
									else
									{
										@* Hvis kunden ingen scootere har, vises denne tekst. *@
										<div class="text-center text-muted py-2">
											Kunde har ingen scooter.
										</div>
									}
								</td>
							</tr>
						}
					}
				}
				else
				{
					@* Hvis ingen kunder matcher søgningen, vis en enkelt tabelrække med besked. *@
					<tr>
						<td colspan="7" class="text-center">Ingen kunder matcher søgningen.</td>
					</tr>
				}
			</tbody>
		</table>
	}
</div>

@* Modal for tilføjelse af en ny scooter til en kunde. Visning styres af visTilføjScooterModal. *@
@if (visTilføjScooterModal)
{
	@* Baggrundslag med en let mørk overlay. *@
	<div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0, 0, 0, 0.5);">
		@* Centeret dialog. *@
		<div class="modal-dialog modal-dialog-centered">
			@* Modalens indhold. *@
			<div class="modal-content">
				@* Modal-header med blå baggrund og hvid tekst. *@
				<div class="modal-header bg-primary text-white">
					@* Titel, der viser hvilken kunde der tilføjes scooter til. *@
					<h5 class="modal-title">Tilføj Scooter til @valgtKunde.Navn</h5>
					@* Lukke-knap (hvid 'x'). *@
					<button type="button" class="btn-close btn-close-white" @onclick="LukTilføjScooterModal"></button>
				</div>
				@* Modal-body med en EditForm til valideret indtastning af ny scooter. *@
				<div class="modal-body">
					<EditForm Model="nyScooter" OnValidSubmit="TilføjScooter">
						<DataAnnotationsValidator />
						@* Tekstfelt til mærke. *@
						<div class="mb-3">
							<label for="maerke" class="form-label">Mærke</label>
							<InputText @bind-Value="nyScooter.Maerke" id="maerke" class="form-control" placeholder="Indtast mærke" />
							<ValidationMessage For="@(() => nyScooter.Maerke)" />
						</div>
						@* Tekstfelt til model. *@
						<div class="mb-3">
							<label for="model" class="form-label">Model</label>
							<InputText @bind-Value="nyScooter.Model" id="model" class="form-control" placeholder="Indtast model" />
							<ValidationMessage For="@(() => nyScooter.Model)" />
						</div>
						@* Tekstfelt til registreringsnummer. *@
						<div class="mb-3">
							<label for="registreringsNummer" class="form-label">Registreringsnummer</label>
							<InputText @bind-Value="nyScooter.RegistreringsNummer" id="registreringsNummer" class="form-control" placeholder="Indtast registreringsnummer" />
							<ValidationMessage For="@(() => nyScooter.RegistreringsNummer)" />
						</div>
						@* Numerisk felt til produktionsår. *@
						<div class="mb-3">
							<label for="produktionsAar" class="form-label">Produktionsår</label>
							<InputNumber @bind-Value="nyScooter.ProduktionsAar" id="produktionsAar" class="form-control" placeholder="Indtast produktionsår" />
							<ValidationMessage For="@(() => nyScooter.ProduktionsAar)" />
						</div>
						@* Knap for at indsende formularen (TilføjScooter). *@
						<div class="d-flex justify-content-end">
							<button type="submit" class="btn btn-primary">Tilføj Scooter</button>
						</div>
					</EditForm>
				</div>
			</div>
		</div>
	</div>
}

@* Et sidepanel, der kan glide ind fra højre for at vise kundeoplysninger og ordrer. *@
@if (visSidePanel)
{
	@* Panel med fast position til højre, med lys baggrund, skygge, og auto-scroll. *@
	<div class="sidepanel bg-light shadow-sm position-fixed" style="width: 400px; top: 0; right: 0; height: 100%; overflow-y: auto; z-index: 1050;">
		@* Header på panelet med blå baggrund, hvid tekst, polstring, og en luk-knap. *@
		<div class="sidepanel-header bg-primary text-white p-3 d-flex justify-content-between align-items-center">
			@* Titel, her 'Kundeoplysninger'. *@
			<h5 class="m-0">Kundeoplysninger</h5>
			@* Lukke-knap til at fjerne panelet fra skærmen. *@
			<button class="btn-close btn-close-white" @onclick="LukSidePanel"></button>
		</div>
		@* Panelets indhold, med polstring på 4. *@
		<div class="sidepanel-body p-4">
			@if (søgeResultatKunde != null)
			{
				@* Viser generelle kundeoplysninger. *@
				<div class="mb-4">
					<p><strong>Kunde ID:</strong> @søgeResultatKunde.KundeId</p>
					<p><strong>Navn:</strong> @søgeResultatKunde.Navn</p>
					<p><strong>Email:</strong> @søgeResultatKunde.Email</p>
					<p><strong>Telefon:</strong> @søgeResultatKunde.Telefonnummer</p>
					<p><strong>Adresse:</strong> @søgeResultatKunde.Adresse</p>
				</div>

				@* Afsnit for visning af kundens ordrer. *@
				<h5 class="text-primary mb-3">Ordrer</h5>
				@if (søgeResultatKunde.Ordre != null && søgeResultatKunde.Ordre.Any())
				{
					@* Viser en tabel for hver enkelt ordre, hvis der findes nogle. *@
					<table class="table table-bordered">
						<thead class="table-light">
							<tr>
								<th>Ordre ID</th>
								<th>Dato</th>
								<th>Total Pris</th>
								<th>Status</th>
								<th>Handling</th>
							</tr>
						</thead>
						<tbody>
							@foreach (var ordre in søgeResultatKunde.Ordre)
							{
								<tr>
									<td>@ordre.OrdreId</td>
									@* Viser dato i formatet dd-MM-yyyy, eller "N/A" hvis dato ikke findes. *@
									<td>@(ordre.Dato.HasValue ? ordre.Dato.Value.ToString("dd-MM-yyyy") : "N/A")</td>
									<td>@ordre.TotalPris kr.</td>
									@* Mulighed for at opdatere ordrestatus via dropdown. *@
									<td>
										<div class="d-flex align-items-center">
											<select class="form-select form-select-sm me-2" @bind="ordre.Status">
												@foreach (var status in Enum.GetValues<OrdreStatus>())
												{
													<option value="@status">@status</option>
												}
											</select>
											<button class="btn btn-sm btn-primary" @onclick="() => OpdaterOrdreStatus(ordre)">Opdater</button>
										</div>
									</td>
									@* Knap til at se yderligere ordredetaljer. *@
									<td>
										<button class="btn btn-sm btn-info" @onclick="() => VisOrdreDetaljer(ordre.OrdreId)">Se Detaljer</button>
									</td>
								</tr>
							}
						</tbody>
					</table>
				}
				else
				{
					@* Hvis kunden ikke har nogen ordrer, vises en tekst. *@
					<p class="text-muted">Kunden har ingen ordrer.</p>
				}
			}
			else
			{
				@* Hvis søgeResultatKunde ikke er hentet endnu. *@
				<p>Indlæser kundeoplysninger...</p>
			}
		</div>
	</div>
}

@* Modal til at vise detaljer om en specifik ordre. *@
@if (visOrdreDetaljerModal)
{
	@* Baggrunds-overlay for modalen. *@
	<div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0, 0, 0, 0.5);">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				@* Header med blå baggrund, hvid tekst, og luk-knap. *@
				<div class="modal-header bg-primary text-white">
					@* Viser Ordre ID i titel. *@
					<h5 class="modal-title">Ordre Detaljer (Ordre ID: @valgtOrdre.OrdreId)</h5>
					<button type="button" class="btn-close btn-close-white" @onclick="LukOrdreDetaljerModal"></button>
				</div>
				@* Modal-body, hvor ydelser, produkter og eventuel lejeaftale vises. *@
				<div class="modal-body">
					@* Sektion for OrdreYdelse. *@
					<h5 class="text-primary mb-3">Ydelser</h5>
					@if (valgtOrdre.OrdreYdelse != null && valgtOrdre.OrdreYdelse.Any())
					{
						@* En tabel med alle ydelser knyttet til ordren. *@
						<table class="table table-bordered">
							<thead class="table-light">
								<tr>
									<th>Ydelse</th>
									<th>Pris</th>
									<th>Scooter</th>
								</tr>
							</thead>
							<tbody>
								@foreach (var ydelse in valgtOrdre.OrdreYdelse)
								{
									<tr>
										@* Navnet på ydelsen. *@
										<td>@ydelse.Ydelse?.Navn</td>
										@* Pris for ydelsen. *@
										<td>@ydelse.BeregnetPris kr.</td>
										@* Viser mærke og model for scooteren tilknyttet ydelsen. *@
										<td>@ydelse.Scooter?.Maerke @ydelse.Scooter?.Model</td>
									</tr>
								}
							</tbody>
						</table>
					}
					else
					{
						@* Hvis der ikke er nogen ydelser, vises en besked. *@
						<p class="text-muted">Ingen ydelser tilføjet.</p>
					}

					@* Sektion for OrdreProdukter. *@
					<h5 class="text-primary mb-3">Produkter</h5>
					@if (valgtOrdre.OrdreProdukter != null && valgtOrdre.OrdreProdukter.Any())
					{
						@* Viser produkter i en tabel med antal og pris. *@
						<table class="table table-bordered">
							<thead class="table-light">
								<tr>
									<th>Produkt</th>
									<th>Antal</th>
									<th>Pris pr. enhed</th>
									<th>Total</th>
								</tr>
							</thead>
							<tbody>
								@foreach (var produkt in valgtOrdre.OrdreProdukter)
								{
									<tr>
										<td>@produkt.Produkt?.ProduktNavn</td>
										<td>@produkt.Antal</td>
										<td>@produkt.Pris kr.</td>
										<td>@(produkt.Antal * produkt.Pris) kr.</td>
									</tr>
								}
							</tbody>
						</table>
					}
					else
					{
						@* Vises hvis ingen produkter er tilknyttet ordren. *@
						<p class="text-muted">Ingen produkter tilknyttet denne ordre.</p>
					}

					@* Sektion for Lejeaftale (hvis en eksisterer). *@
					<h5 class="text-primary mb-3">Lejeaftale</h5>
					@if (valgtOrdre.LejeAftale != null)
					{
						<div class="mb-3">
							<p><strong>Startdato:</strong> @valgtOrdre.LejeAftale.StartDato?.ToString("dd-MM-yyyy")</p>
							<p><strong>Slutdato:</strong> @valgtOrdre.LejeAftale.SlutDato?.ToString("dd-MM-yyyy")</p>
							<p><strong>Daglig Leje:</strong> @valgtOrdre.LejeAftale.DagligLeje kr.</p>
							<p><strong>Forsikringspris:</strong> @valgtOrdre.LejeAftale.ForsikringsPris kr.</p>
							<p><strong>Kilometer pris:</strong> @valgtOrdre.LejeAftale.KilometerPris kr.</p>
							<p><strong>Antal kørte Km:</strong> @valgtOrdre.LejeAftale.KortKilometer Km.</p>
							<p><strong>Selvrisiko:</strong> @valgtOrdre.LejeAftale.Selvrisiko Kr.</p>
						</div>
						@* Overskrift for scootere i lejeaftalen. *@
						<h6 class="text-primary">Scootere</h6>
						@if (valgtOrdre.LejeAftale.LejeScooter != null && valgtOrdre.LejeAftale.LejeScooter.Any())
						{
							@* Viser en liste over scootere tilknyttet lejeaftalen. *@
							<ul class="list-unstyled">
								@foreach (var scooter in valgtOrdre.LejeAftale.LejeScooter)
								{
									<li>🛵 @scooter.ScooterMaerke @scooter.ScooterModel</li>
								}
							</ul>
						}
						else
						{
							@* Ingen scootere på denne lejeaftale. *@
							<p class="text-muted">Ingen scootere knyttet til lejeaftalen.</p>
						}
					}
					else
					{
						@* Ingen lejeaftale for denne ordre. *@
						<p class="text-muted">Ingen lejeaftale knyttet til denne ordre.</p>
					}

					@* Viser en sektion for total pris på ordren. *@
					<h5 class="text-primary mt-4">Total Pris</h5>
					<p class="fs-5"><strong>@valgtOrdre.TotalOrdrePris kr.</strong></p>
				</div>
				@* Modal-footer med en luk-knap. *@
				<div class="modal-footer">
					<button class="btn btn-secondary" @onclick="LukOrdreDetaljerModal">Luk</button>
				</div>
			</div>
		</div>
	</div>
}

@* En modal, der enten bruges til at oprette eller redigere en kunde, afhængigt af modalTitel. *@
@if (visModal)
{
	@* Mørkt overlay, der aktiverer modalen som 'show'. *@
	<div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0, 0, 0, 0.5);">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				@* Modal-header, hvor modalTitel vises og en luk-knap. *@
				<div class="modal-header bg-primary text-white">
					<h5 class="modal-title">@modalTitel</h5>
					<button type="button" class="btn-close btn-close-white" @onclick="LukModal"></button>
				</div>
				@* Modal-body, der indeholder en EditForm til at oprette/redigere en kunde. *@
				<div class="modal-body">
					<EditForm Model="valgtKunde" OnValidSubmit="GemKunde">
						<DataAnnotationsValidator />
						@* Første række med navn og email. *@
						<div class="row">
							<div class="col-md-6 mb-3">
								<label for="navn" class="form-label"><strong>Navn:</strong></label>
								<InputText id="navn" @bind-Value="valgtKunde.Navn" class="form-control" />
								<ValidationMessage For="@(() => valgtKunde.Navn)" />
							</div>
							<div class="col-md-6 mb-3">
								<label for="email" class="form-label"><strong>Email:</strong></label>
								<InputText id="email" @bind-Value="valgtKunde.Email" class="form-control" />
								<ValidationMessage For="@(() => valgtKunde.Email)" />
							</div>
						</div>
						@* Anden række med telefon og adresse. *@
						<div class="row">
							<div class="col-md-6 mb-3">
								<label for="telefon" class="form-label"><strong>Telefon:</strong></label>
								<InputNumber id="telefon" @bind-Value="valgtKunde.Telefonnummer" class="form-control" />
								<ValidationMessage For="@(() => valgtKunde.Telefonnummer)" />
							</div>
							<div class="col-md-6 mb-3">
								<label for="adresse" class="form-label"><strong>Adresse:</strong></label>
								<InputText id="adresse" @bind-Value="valgtKunde.Adresse" class="form-control" />
								<ValidationMessage For="@(() => valgtKunde.Adresse)" />
							</div>
						</div>
						@* Modal-footer med to knapper: 'Gem' og 'Slet'. *@
						<div class="modal-footer mt-3">
							<button class="btn btn-primary" type="submit">Gem</button>
							<button class="btn btn-danger" @onclick="VisBekræftSletModal">Slet</button>
						</div>
					</EditForm>
				</div>
			</div>
		</div>
	</div>
}

@* Modal til at bekræfte, om man vil slette en kunde. *@
@if (visBekræftSletModal)
{
	@* Ligner de andre modaler: overlay, lille dialog, header i rød baggrund. *@
	<div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0, 0, 0, 0.5);">
		<div class="modal-dialog modal-sm">
			<div class="modal-content">
				<div class="modal-header bg-danger text-white">
					<h5 class="modal-title">Bekræft Sletning</h5>
					<button type="button" class="btn-close btn-close-white" @onclick="LukBekræftSletModal"></button>
				</div>
				@* Body med advarsel. *@
				<div class="modal-body text-center">
					<p class="fw-bold">Er du sikker på, at du vil slette kunden?</p>
					<p class="text-danger"><strong>@valgtKunde.Navn</strong></p>
				</div>
				@* Modal-footer med 'Annuller' og 'Ja, Slet'. *@
				<div class="modal-footer d-flex justify-content-between">
					<button class="btn btn-secondary w-45" @onclick="LukBekræftSletModal">Annuller</button>
					<button class="btn btn-danger w-45" @onclick="SletBekræftetKunde">Ja, Slet</button>
				</div>
			</div>
		</div>
	</div>
}

@* CSS til sidepanelet. *@
<style>
	.sidepanel {
		position: fixed;
		right: 0;
		top: 0;
		height: 100%;
		width: 400px;
		background-color: #f8f9fa;
		box-shadow: -3px 0px 10px rgba(0, 0, 0, 0.3);
		overflow-y: auto;
		padding: 20px;
		z-index: 1050;
	}
</style>

@* En sektion i bunden med en alert-boks, der viser Scooterland-info. *@
<div class="d-flex justify-content-center align-items-center position-relative mt-4" style="height: 200px;">
	@* En alert, der har en gradient-baggrund, afrundede hjørner og hvid tekst. *@
	<div class="alert border rounded-3 text-center"
		 style="max-width: 700px; width: 90%; padding: 20px; background: linear-gradient(to bottom, #1D3557, #457B9D); color: white;">
		@* En lidt større overskrift med ikon. *@
		<h4 class="fw-bold mb-3">
			<i class="fas fa-motorcycle"></i> Scooterland
		</h4>
		@* Indholdet fordeles i to kolonner ved hjælp af flex. *@
		<div class="d-flex justify-content-between">
			<div class="text-start">
				<p class="mb-2">
					<strong><i class="fas fa-map-marker-alt"></i> Adresse:</strong> Hovedgade 123, 4000 Roskilde
				</p>
				<p class="mb-2">
					<strong><i class="fas fa-phone-alt"></i> Telefon:</strong> 12 34 56 78
				</p>
			</div>
			<div class="text-start">
				<p class="mb-2">
					<strong><i class="fas fa-envelope"></i> Email:</strong> kontakt@scooterland.dk
				</p>
				<p class="mb-0">
					<strong><i class="fas fa-calendar-alt"></i> Dags dato:</strong> @DateTime.Now.ToString("dd-MM-yyyy")
				</p>
			</div>
		</div>
	</div>
</div>

@* CSS til alert-boksen. *@
<style>
	.alert {
		background: linear-gradient(to bottom, #1D3557, #457B9D); /* Match farve fra sidebar */
		border: none; /* Fjern kant */
	}

		.alert h4 {
			font-size: 1.75rem; /* Fremhæv overskriften */
			color: white; /* Hvid tekst */
		}

		.alert p {
			font-size: 1rem; /* Læsbar tekst */
			color: white; /* Hvid tekst */
		}

		.alert i {
			margin-right: 8px; /* Plads mellem ikon og tekst */
			color: white; /* Hvid farve til ikoner */
		}

		.alert .text-start {
			flex: 1; /* Fordel pladsen ligeligt */
		}
</style>

@* Link til en CSS-fil for scooter-animationer. *@
<link rel="stylesheet" href="css/ScooterAnimation.css">

@* Container til scooter-ikonet. *@
<div class="scooter-container">

	@* Et SVG-element med en scooter-grafik, spejlvendt med transform: scaleX(-1). *@
	<svg class="scooter" xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 128 128" style="transform: scaleX(-1);">
		<path fill="#ea6c3a" d="M109.4 59.1h8.8c2 0 3.5 1.6 3.5 3.5c0 2-1.6 3.5-3.5 3.5h-8.8z" />
		<path fill="#fac136" d="M29.6 25.3c-.4 2.8-1.1 8.1-1.5 10.9c-.2 1.1-1.4 1.8-2.4 1.3c-2.9-1.4-4.7-4.5-4.2-7.8s3.1-5.8 6.2-6.4c1.1-.2 2.1.8 1.9 2" />
		<circle cx="19.4" cy="90.2" r="17.5" fill="#2f2f2f" />
		<circle cx="19.4" cy="90.2" r="9.7" fill="#65878d" />
		<circle cx="97.7" cy="90.2" r="17.5" fill="#2f2f2f" />
		<circle cx="97.7" cy="90.2" r="9.7" fill="#65878d" />
		<path fill="#47c0e5" d="M95.7 54.7h.2c2.1.1 31.3 2.8 31.3 34.6c0 1.9-1.6 3.5-3.5 3.5H51.6c-7.6 0-14.7-3.3-19.7-9l-9.6-11.1c-1.3-1.5-1.8-3.5-1.4-5.5c2-9.1 5.9-17.7 11.6-25.2l1.8-2.4h7.5l-7 28.9c.5 8.7 7.8 15.5 16.5 15.6h12.3c5.6 0 10.1-4.5 10.1-10.1c0-3.5-1.8-6.7-4.8-8.6L63 61.7c-1.2-.8-2-2.2-2-3.6v-3.5h34.7z" />
		<path fill="#bae9f3" d="M94.6 62.1q-.15 0 0 0c-.8 0-1.4.7-1.4 1.4c0 .8.6 1.4 1.4 1.4c12.3 0 22.2 9.9 22.2 22.2c0 .8.6 1.4 1.4 1.4s1.4-.6 1.4-1.4c0-13.8-11.2-25-25-25" />
		<path fill="#2f2f2f" d="M66.2 58.5L61 56.1c-.8-.4-1.3-1.2-1.3-2c0-4.7 3.8-8.6 8.6-8.6h14.5c4.9 0 9.9-.3 14.8-1c4.8-.4 8.8 3.4 8.8 8.2v3.4c0 1.1-.9 2.1-2.1 2.1l-30.8 1.3c-2.5.5-5 .1-7.3-1m43.5-31.1l-.1.2c-1.8 2.7-2.8 5.8-2.8 9v2c0 .9.6 1.8 1.5 2.1l1.2.4c1.1.3 2.3-.3 2.7-1.4l3-9.9c.4-1.2-.3-2.4-1.5-2.7l-1.7-.5c-.9-.3-1.8 0-2.3.8" />
		<path fill="#2f2f2f" d="M115.5 30c.6.2.9.8.7 1.4l-5.7 20.2c-.5 1.9-2 3.5-3.8 4.2l-2.5 1v-2.5l.6-.2c2-.7 3.5-2.3 4.1-4.4l5.2-19c.2-.5.8-.9 1.4-.7" />
		<path fill="#47c0e5" d="M42.7 37.4L44 33c.4-1.2 0-2.6-1-3.4L38.8 26c-1.7-1.4-3.8-2.3-6-2.5l-6.5-.5c-.5 0-.9.2-1.1.6l-.8 1.8c-1.3 2.9-1.9 6-1.7 9.1l.1 1.7c0 .5.4.9.9 1l4.3.6c3.4.5 5.5 4 4.2 7.3l8.6-1.7z" />
		<path fill="#2f2f2f" d="M38.4 26s-1.8-.8-2.8 1.7c-1 2.4 1.1 4.6 1.1 4.6l7.5 2.5c1.5.5 3.1-.5 3.4-2.1c.2-1.1-.4-2.2-1.4-2.7z" />
		<path fill="#47c0e5" d="M3 83.7h4.5c10.3.1 20.3 3.4 28.8 9.4c1.4 1 3.3-.1 3.2-1.9c-.1-2.2-.5-5.2-1.6-8.3c-2-6-6.2-11.3-12.8-13.1c-13.7-3.7-21 5.5-23.9 10.6c-.7 1.6.3 3.3 1.8 3.3" />
		<path fill="none" stroke="#bae9f3" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2.5" d="M15 74.4s7.2-2.4 13.1 2.1c4 3 5.3 7.3 5.3 7.3" />
	</svg>

</div>

@code {
	// Liste over alle kunder.
	private List<Kunde> kunder = new();

	// Kunde-objekt der bruges, når en kunde oprettes eller redigeres.
	private Kunde valgtKunde = new();

	// Kunde-objekt til sletning (håndteres ved bekræftelsesmodal).
	private Kunde kundeTilSletning = new();

	// Kunde-objekt der vises i sidepanelet (inklusive ordrer).
	private Kunde søgeResultatKunde = new();

	// Oprettelse af et nyt KundeScooter-objekt, når en scooter skal tilføjes.
	private KundeScooter nyScooter = new();

	// Styrer visning af "Tilføj scooter"-modalen.
	private bool visTilføjScooterModal = false;

	// Styrer visningen af den generelle kunde-modal (opret/rediger).
	private bool visModal = false;

	// Styrer, om sidepanelet med kundeoplysninger er åbent.
	private bool visSidePanel = false;

	// Titel på modalvinduet, skifter mellem "Opret" eller "Rediger".
	private string modalTitel = "";

	// Gemmer det kundeId, der skal vises i sidepanelet.
	private int søgeKundeId;

	// Styrer visningen af slet-bekræftelsesmodal.
	private bool visBekræftSletModal = false;

	// Variabler til ordrer og ordre-detaljer.
	private int valgtOrdreId; // Aktuelt valgte ordre-ID.
	private Ordre? valgtOrdre; // Indeholder detaljer om den valgte ordre.
	private bool visOrdreDetaljerModal; // Styrer, om ordredetalje-modal skal vises.

	// Lagrer en liste over scootere pr. kundeId, så de kan toggles i tabellen.
	private Dictionary<int, List<KundeScooter>> kundeScootere = new();

	// Huskes for at styre, hvilken kundeId's scootere der p.t. er synlige.
	private int? visScooterKundeId = null;

	// Tekst, der bruges til at søge i kunder.
	private string søgeTekst = "";

	// Filtreret liste af kunder, som opdateres ved søgning.
	private List<Kunde> filtreredeKunder = new();

	// Egenskab, der opdaterer søgeTekst og udfører søgning automatisk.
	private string SøgeTekst
	{
		get => søgeTekst;
		set
		{
			if (søgeTekst != value)
			{
				søgeTekst = value;
				_ = PerformSearchAsync(); // Start asynkron søgning.
			}
		}
	}

	// Asynkron metode, der kalder SøgKunder og tvinger en UI-opdatering.
	private async Task PerformSearchAsync()
	{
		await SøgKunder();
		StateHasChanged(); // Tvinger en genrendring af UI.
	}

	// Simpel placeholder-metode til fremvisning af scootere (her blot en log).
	private void VisScootere(int kundeId)
	{
		Console.WriteLine($"Henter scootere for kunde med ID: {kundeId}");
		// Kunne implementere ekstra funktionalitet eller navigation.
	}

	// Slår visningen af scootere for en given kunde til/fra og henter data, hvis nødvendigt.
	private async Task ToggleScooterVisning(int kundeId)
	{
		if (visScooterKundeId == kundeId)
		{
			visScooterKundeId = null; // Skjul scootere, hvis de allerede vises.
		}
		else
		{
			try
			{
				// Henter scootere for kunden via API'et.
				var response = await Http.GetAsync($"api/KundeScooter/{kundeId}/scootere");

				if (response.IsSuccessStatusCode)
				{
					var scootere = await response.Content.ReadFromJsonAsync<List<KundeScooter>>();
					kundeScootere[kundeId] = scootere ?? new List<KundeScooter>();
				}
				else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
				{
					// Hvis API returnerer 404, har kunden ingen scootere.
					kundeScootere[kundeId] = new List<KundeScooter>();
				}
				else
				{
					Console.WriteLine($"Fejl ved hentning af scootere for kunde {kundeId}: {response.StatusCode}");
				}

				visScooterKundeId = kundeId; // Sæt, at vi nu viser scootere for denne kunde.
			}
			catch (Exception ex)
			{
				Console.WriteLine($"Fejl ved hentning af scootere for kunde {kundeId}: {ex.Message}");
				kundeScootere[kundeId] = new List<KundeScooter>();
			}
		}

		StateHasChanged(); // Opdaterer UI, så vi kan se ændringen.
	}

	// Lifecycle-metode, der kører, når komponenten initialiseres.
	protected override async Task OnInitializedAsync()
	{
		await HentAlleKunder(); // Hent alle kunder fra API ved opstart.
	}

	// Henter alle kunder fra API og gemmer dem lokalt i listerne kunder og filtreredeKunder.
	private async Task HentAlleKunder()
	{
		try
		{
			kunder = await Http.GetFromJsonAsync<List<Kunde>>("api/Kunde");
			filtreredeKunder = new List<Kunde>(kunder); // Start med at vise alle kunder i tabellen.
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Fejl ved hentning af kunder: {ex.Message}");
			kunder = new List<Kunde>();
			filtreredeKunder = new List<Kunde>();
		}
	}

	// Åbner sidepanelet til at vise ordreinformationer for en specifik kunde.
	private async Task ÅbnSidePanel(int kundeId)
	{
		søgeKundeId = kundeId;
		visSidePanel = true;
		await HentKundeDetaljer(kundeId);
	}

	// Viser bekræftelsesmodal for at slette en kunde.
	private void VisBekræftSletModal()
	{
		kundeTilSletning = valgtKunde;
		visBekræftSletModal = true;
	}

	// Lukker bekræftelsesmodalen uden at slette.
	private void LukBekræftSletModal()
	{
		visBekræftSletModal = false;
	}

	// Henter detaljer om en kunde (inklusive ordrer) og gemmer i søgeResultatKunde, så sidepanelet kan vise dem.
	private async Task HentKundeDetaljer(int kundeId)
	{
		try
		{
			søgeResultatKunde = await Http.GetFromJsonAsync<Kunde>($"api/Kunde/{kundeId}/details");
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Fejl ved hentning af kundeoplysninger: {ex.Message}");
		}
	}

	// Søgning blandt kunder baseret på søgeTekst; sammenligner ID, Navn og telefonnummer.
	private async Task SøgKunder()
	{
		if (string.IsNullOrWhiteSpace(søgeTekst))
		{
			// Hvis søgetekst er tom, ryddes den filtrerede liste.
			filtreredeKunder = new List<Kunde>();
		}
		else
		{
			var søgetekstLower = søgeTekst.ToLower();
			filtreredeKunder = kunder.Where(k =>
				k.KundeId.ToString().Contains(søgeTekst) ||
				(!string.IsNullOrEmpty(k.Navn) && k.Navn.ToLower().Contains(søgetekstLower)) ||
				k.Telefonnummer?.ToString().Contains(søgeTekst) == true
			).ToList();
		}
	}

	// Nulstiller søgefeltet og viser hele listen af kunder igen.
	private void RydSøgning()
	{
		søgeTekst = "";
		filtreredeKunder = new List<Kunde>(kunder);
	}

	// Viser modal til at tilføje en scooter til en eksisterende kunde.
	private void VisTilføjScooterModal(Kunde kunde)
	{
		valgtKunde = kunde;
		nyScooter = new KundeScooter();
		visTilføjScooterModal = true;
	}

	// Lukker modalvinduet til at tilføje scooter.
	private void LukTilføjScooterModal()
	{
		visTilføjScooterModal = false;
	}

	// Tilføjer en scooter til den valgte kunde via API-kald.
	private async Task TilføjScooter()
	{
		try
		{
			nyScooter.KundeId = valgtKunde.KundeId; // Sæt, hvilken kunde scooteren hører til.

			var response = await Http.PostAsJsonAsync($"api/KundeScooter/{valgtKunde.KundeId}/add-scooter", nyScooter);
			if (response.IsSuccessStatusCode)
			{
				await HentAlleKunder(); // Opdater kundeoversigten.
				LukTilføjScooterModal(); // Luk modal.
			}
			else
			{
				Console.WriteLine("Fejl ved oprettelse af scooter.");
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"En fejl opstod: {ex.Message}");
		}
	}

	// Lukker sidepanelet.
	private void LukSidePanel()
	{
		visSidePanel = false;
	}

	// Viser modal til at oprette en ny kunde (kundeId = 0).
	private void VisOpretModal()
	{
		valgtKunde = new Kunde();
		modalTitel = "Opret Kunde";
		visModal = true;
	}

	// Viser modal til at redigere en eksisterende kunde.
	private void VisRedigerModal(Kunde kunde)
	{
		valgtKunde = kunde;
		modalTitel = "Rediger Kunde";
		visModal = true;
	}

	// Gemmer en kunde (nyt opret eller redigeret), kalder Post eller Put på API'et.
	private async Task GemKunde()
	{
		if (valgtKunde.KundeId == 0)
		{
			await Http.PostAsJsonAsync("api/Kunde", valgtKunde);
		}
		else
		{
			await Http.PutAsJsonAsync($"api/Kunde/{valgtKunde.KundeId}", valgtKunde);
		}
		await HentAlleKunder();
		LukModal();
	}

	// Lukker opret/rediger-modal uden at gemme.
	private void LukModal()
	{
		visModal = false;
	}

	// Bekræfter sletning af kunde og kalder DELETE på API.
	private async Task SletBekræftetKunde()
	{
		try
		{
			var response = await Http.DeleteAsync($"api/Kunde/{kundeTilSletning.KundeId}");
			if (response.IsSuccessStatusCode)
			{
				kunder.Remove(kundeTilSletning);
				await HentAlleKunder();
				LukBekræftSletModal();
			}
			else
			{
				var fejl = await response.Content.ReadAsStringAsync();
				Console.WriteLine($"Fejl ved sletning: {fejl}");
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Fejl ved sletning af kunde: {ex.Message}");
		}
	}

	// Opdaterer status for en specifik ordre via API, og udfører evt. handling ved Annulleret/Betalt.
	private async Task OpdaterOrdreStatus(Ordre ordre)
	{
		try
		{
			var response = await Http.PutAsJsonAsync($"api/Ordre/{ordre.OrdreId}/status", ordre.Status);
			if (response.IsSuccessStatusCode)
			{
				Console.WriteLine($"Ordrestatus for ID {ordre.OrdreId} opdateret til {ordre.Status}.");

				if (ordre.Status == OrdreStatus.Annulleret || ordre.Status == OrdreStatus.Betalt)
				{
					Console.WriteLine("Udfører yderligere handlinger for status: " + ordre.Status);
				}
				await HentKundeDetaljer(ordre.KundeId);
			}
			else
			{
				Console.WriteLine($"Fejl ved opdatering af ordrestatus for ID {ordre.OrdreId}.");
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"En fejl opstod ved opdatering af status: {ex.Message}");
		}
	}

	// Henter detaljeret ordreinfo og viser en modal med disse oplysninger.
	private async Task VisOrdreDetaljer(int ordreId)
	{
		try
		{
			valgtOrdre = søgeResultatKunde.Ordre.FirstOrDefault(o => o.OrdreId == ordreId);
			if (valgtOrdre == null)
			{
				Console.WriteLine($"Ingen ordre fundet med ID {ordreId}.");
				return;
			}

			var response = await Http.GetFromJsonAsync<Ordre>($"api/Ordre/{ordreId}");
			if (response != null)
			{
				valgtOrdre = response;
			}

			visOrdreDetaljerModal = true;
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Fejl ved hentning af ordredetaljer: {ex.Message}");
		}
	}

	// Lukker modal med ordredetaljer.
	private void LukOrdreDetaljerModal()
	{
		visOrdreDetaljerModal = false;
	}
}

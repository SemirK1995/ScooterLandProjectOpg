@page "/opretordre"
@using ScooterLandProjectOpg.Shared.DTO
@using ScooterLandProjectOpg.Shared.Models
@inject HttpClient Http

<h3>Opret Ordre</h3>

@if (valgtKunde != null)
{
	<div class="alert alert-info">
		<h5>Valgt Kunde</h5>
		<p>
			<strong>ID:</strong> @valgtKunde.KundeId<br />
			<strong>Navn:</strong> @valgtKunde.Navn<br />
			<strong>Telefon:</strong> @valgtKunde.Telefonnummer
		</p>
		<button class="btn btn-warning" @onclick="RydValgtKunde">Ryd Valg</button>
	</div>
}


<!-- Tabs navigation -->
<ul class="nav nav-tabs">
	<li class="nav-item">
		<a class="nav-link @(aktivTab == "ordre" ? "active" : "")" @onclick="@(() => AktivTabSkift("ordre"))">
			Ordre
		</a>
	</li>
	<li class="nav-item">
		<a class="nav-link @(aktivTab == "lejeaftale" ? "active" : "")" @onclick="@(() => AktivTabSkift("lejeaftale"))">
			Lejeaftale
		</a>
	</li>
	<li class="nav-item">
		<a class="nav-link @(aktivTab == "produkter" ? "active" : "")" @onclick="@(() => AktivTabSkift("produkter"))">
			Produkter
		</a>
	</li>
</ul>

<div class="tab-content mt-4">
	@if (aktivTab == "ordre")
	{
		<!-- Opret Ordre Form -->
		<div>
			<div class="form-group">
				<input id="search" class="form-control" @bind="SøgeTekst" placeholder="Søg på Kunde ID, Navn eller Telefonnummer" />

			</div>

			@if (filtreredeKunder.Any())
			{
				<ul class="list-group mt-2">
					@foreach (var kunde in filtreredeKunder)
					{
						<li class="list-group-item d-flex justify-content-between align-items-center">
							<span>@($"{kunde.KundeId} - {kunde.Navn} ({kunde.Telefonnummer})")</span>
							<button class="btn btn-primary btn-sm" @onclick="() => VælgKunde(kunde.KundeId)">Vælg</button>
						</li>
					}
				</ul>
			}
			else if (!string.IsNullOrWhiteSpace(søgeTekst))
			{
				<p class="text-muted mt-2">Ingen kunder matcher søgningen.</p>
			}
			@if (valgtKundeId > 0)
			{
				<div>

					@if (alleYdelser != null && alleYdelser.Any())
					{
						<table class="table">
							<thead>
								<tr>
									<th>Ydelse</th>
									<th>Standard Pris</th>
									<th>Handlinger</th>
								</tr>
							</thead>
							<tbody>
								@foreach (var ydelse in alleYdelser)
								{
									<tr>
										<td>@ydelse.Navn</td>
										<td>@ydelse.StandardPris?.ToString("F2") kr.</td>
										<td>
											<button class="btn btn-success" @onclick="() => TilføjYdelse(ydelse)">Tilføj</button>
										</td>
									</tr>
								}
							</tbody>
						</table>
					}
					else
					{
						<p>Ingen ydelser tilgængelige.</p>
					}
				</div>

				<div class="mt-3">
					<h5>Tilføjet Ydelser:</h5>
					@if (valgteOrdreYdelser.Any())
					{
						<table class="table">
							<thead>
								<tr>
									<th>Ydelse</th>
									<th>Standard Pris</th>
									<th>Aftalt Pris</th>
									<th>Handlinger</th>
								</tr>
							</thead>
							<tbody>
								@foreach (var ordreYdelse in valgteOrdreYdelser)
								{
									<tr>
										<td>@ordreYdelse.Ydelse.Navn</td>
										<td>@ordreYdelse.Ydelse.StandardPris?.ToString("F2") kr.</td>
										<td>
											<InputNumber @bind-Value="ordreYdelse.AftaltPris" class="form-control" />
										</td>
										<td>
											<select class="form-control" @bind="ordreYdelse.ScooterId">
												<option value="">-- Vælg en scooter --</option>
												@foreach (var scooter in kundeScootere) // KundeScootere skal være tilgængelig
												{
													<option value="@scooter.ScooterId">@($"{scooter.Maerke} {scooter.Model}")</option>
												}
											</select>
										</td>
										<td>
											<button class="btn btn-danger" @onclick="() => FjernYdelse(ordreYdelse)">Fjern</button>
										</td>
									</tr>
								}
							</tbody>
						</table>

						<h5>Totalpris: @TotalPris kr.</h5>
					}
					else
					{
						<p>Ingen ydelser er tilføjet.</p>
					}

					<button class="btn btn-primary mt-3" @onclick="VisBekræftelse">Gem Ordre</button>
				</div>
			}
			else
			{
				<p>Vælg en kunde for at se tilgængelige ydelser.</p>
			}
		</div>
	}
	else if (aktivTab == "lejeaftale")
	{
		<!-- Opret Lejeaftale Form -->
		<div>
			<h5>Opret Lejeaftale</h5>
			<div class="form-group">
				<label>Startdato:</label>
				<input type="date" class="form-control" @bind="lejeaftale.StartDato" />
			</div>
			<div class="form-group">
				<label>Slutdato:</label>
				<input type="date" class="form-control" @bind="lejeaftale.SlutDato" />
			</div>
			<div class="form-group">
				<label>Daglig Leje:</label>
				<input type="number" class="form-control" @bind="lejeaftale.DagligLeje" />
			</div>
			<div class="form-group">
				<label for="forsikringsPris">Forsikringspris pr. dag:</label>
				<input type="number" class="form-control" @bind="lejeaftale.ForsikringsPris" readonly />
				<small class="text-muted">Selvrisiko på 1000 kr. tilføjes kun i tilfælde af skade.</small>
			</div>

			<div class="form-group">
				<label>Kort Kilometer:</label>
				<input type="number" class="form-control" @bind="lejeaftale.KortKilometer" />
			</div>

			<div class="form-group mt-3">
				<label for="scooter">Vælg en ledig scooter:</label>

				@if (ledigeScootere == null || !ledigeScootere.Any())
				{
					<p class="text-warning">Der er i øjeblikket ingen ledige scootere til lejeaftaler.</p>
				}
				else
				{
					<select id="scooter" class="form-control" @bind="valgtLejeScooterId">
						<option value="">-- Vælg en scooter --</option>
						@foreach (var scooter in ledigeScootere)
						{
							<option value="@scooter.LejeScooterId">@($"{scooter.ScooterMaerke} {scooter.ScooterModel} - {scooter.RegistreringsNummer}")</option>
						}
					</select>
				}
			</div>


			<h5>Samlet pris for lejeaftale: @BeregnLejeAftaleTotalPris() kr.</h5>
			<p class="text-warning">
				Bemærk: Der er en Selvrisiko på 1000 kr. Hvis scooteren returneres med skade.
			</p>
		</div>
	}
	else if (aktivTab == "produkter")
	{
		<!-- Indhold for Produkter-fanen -->
		<div>
			<h5>Tilføj Produkter</h5>
			<p class="text-muted">Vælg produkter, der skal inkluderes i ordren.</p>
			@if (alleProdukter == null || !alleProdukter.Any())
			{
				<p>Ingen produkter tilgængelige.</p>
			}
			else
			{
				<table class="table">
					<thead>
						<tr>
							<th>Produkt</th>
							<th>Pris</th>
							<th>Antal</th>
							<th>Handlinger</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var produkt in alleProdukter)
						{
							<tr>
								<td>@produkt.ProduktNavn</td>
								<td>@produkt.Pris?.ToString("F2") kr.</td>
								<td>
									<InputNumber @bind-Value="produkt.Antal" class="form-control" />
								</td>
								<td>
									<button class="btn btn-success" @onclick="() => TilføjProdukt(produkt)">Tilføj</button>
								</td>
							</tr>
						}
					</tbody>
				</table>
			}
			<h5>Valgte Produkter:</h5>
			@if (valgteProdukter.Any())
			{
				<table class="table">
					<thead>
						<tr>
							<th>Produkt</th>
							<th>Pris</th>
							<th>Antal</th>
							<th>Handlinger</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var produkt in valgteProdukter)
						{
							<tr>
								<td>@produkt.ProduktNavn</td>
								<td>@produkt.Pris?.ToString("F2") kr.</td>
								<td>@produkt.Antal</td>
								<td>
									<button class="btn btn-danger" @onclick="() => FjernProdukt(produkt)">Fjern</button>
								</td>
							</tr>
						}
					</tbody>
				</table>
				<h5>Total pris for produkter: @TotalPrisForProdukter kr.</h5>
			}
			else
			{
				<p>Ingen produkter valgt.</p>
			}
		</div>
	}
</div>



<!-- Bekræftelsesmodal -->
@if (visBekræftelsesModal)
{
	<div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0, 0, 0, 0.5);">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Bekræft Oprettelse</h5>
					<button type="button" class="btn-close" @onclick="LukBekræftelsesModal"></button>
				</div>
				<div class="modal-body">
					<p>Er du sikker på, at du vil oprette denne ordre?</p>
				</div>
				<div class="modal-footer">
					<button class="btn btn-danger" @onclick="LukBekræftelsesModal">Annuller</button>
					<button class="btn btn-primary" @onclick="BekræftOprettelse">Bekræft</button>
				</div>
			</div>
		</div>
	</div>
}

@if (visSuccesBesked)
{
	<div class="alert alert-success mt-3">
		Ordren blev oprettet succesfuldt!
	</div>
}

@code {
	private List<Kunde> kunder = new();
	private List<Ydelse> alleYdelser = new();
	private List<LejeScooter> ledigeScootere = new();
	private List<OrdreYdelse> valgteOrdreYdelser = new List<OrdreYdelse>();
	private CreateLejeAftaleDto lejeaftale = new();
	private List<KundeScooter> kundeScootere = new();
	private List<Produkt> alleProdukter = new();
	private List<Produkt> valgteProdukter = new();
	private int valgtKundeId;
	private int? valgtLejeScooterId;
	private int? valgtKundeScooterId;
	private string aktivTab = "ordre";
	private bool visBekræftelsesModal = false;
	private bool visSuccesBesked = false;
	private Kunde valgtKunde; // Gemmer oplysninger om den valgte kunde

	private double? TotalPrisFraBackend { get; set; }

	private string søgeTekst = ""; // Søgeteksten fra brugeren
	private List<Kunde> filtreredeKunder = new(); // Den filtrerede liste af kunder

	private string SøgeTekst
	{
		get => søgeTekst;
		set
		{
			if (søgeTekst != value)
			{
				søgeTekst = value;
				_ = PerformSearchAsync(); // Kald søgning når søgeTekst ændres

			}
		}
	}
	private async Task PerformSearchAsync()
	{
		await SøgKunderAsync();
		StateHasChanged(); // Tving UI-opdatering
	}

	private double TotalPris => valgteOrdreYdelser.Sum(oy => oy.AftaltPris ?? oy.Ydelse.StandardPris ?? 0) + BeregnLejeAftaleTotalPris() + TotalPrisForProdukter;
	private double TotalPrisForProdukter => valgteProdukter.Sum(p => (p.Pris ?? 0) * (p.Antal ?? 1));


	protected override async Task OnInitializedAsync()
	{
		try
		{
			// Hent kunder og ydelser
			kunder = await Http.GetFromJsonAsync<List<Kunde>>("api/Kunde");
			alleYdelser = await Http.GetFromJsonAsync<List<Ydelse>>("api/Ydelse");
			//Hent produkter
			alleProdukter = await Http.GetFromJsonAsync<List<Produkt>>("api/Produkt");
			// Hent ledige scootere
			ledigeScootere = await Http.GetFromJsonAsync<List<LejeScooter>>("api/lejescooter/available");

			// Hvis ingen scootere er tilgængelige, initialiser en tom liste og log besked
			if (ledigeScootere == null || !ledigeScootere.Any())
			{
				Console.WriteLine("Ingen ledige scootere fundet.");
				ledigeScootere = new List<LejeScooter>();
			}
		}
		catch (HttpRequestException ex)
		{
			Console.WriteLine($"Fejl ved hentning af data: {ex.Message}");
			ledigeScootere = new List<LejeScooter>(); // Initialiser som tom liste for at undgå fejl
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Uventet fejl: {ex.Message}");
			ledigeScootere = new List<LejeScooter>();
		}
	}
	
	private void NulstilOrdreData()
	{
		valgteProdukter.Clear();
		valgteOrdreYdelser.Clear();
		lejeaftale = new CreateLejeAftaleDto();
		valgtLejeScooterId = null;
		valgtKunde = null;
		valgtKundeId = 0;
		TotalPrisFraBackend = null;
		aktivTab = "ordre"; // Sæt standard-tabben tilbage
		visBekræftelsesModal = false;
		visSuccesBesked = false;
		StateHasChanged(); // Tving UI-opdatering
	}
	private void TilføjProdukt(Produkt produkt)
	{
		var eksisterendeProdukt = valgteProdukter.FirstOrDefault(p => p.ProduktId == produkt.ProduktId);
		if (eksisterendeProdukt == null)
		{
			valgteProdukter.Add(new Produkt
				{
					ProduktId = produkt.ProduktId,
					ProduktNavn = produkt.ProduktNavn,
					Pris = produkt.Pris,
					Antal = produkt.Antal ?? 1
				});
		}
		else
		{
			eksisterendeProdukt.Antal += produkt.Antal ?? 1; // Opdater antal
		}
	}
	

	private void FjernProdukt(Produkt produkt)
	{
		valgteProdukter.Remove(produkt);
	}


	private void FiltrerKunder()
	{
		if (string.IsNullOrWhiteSpace(søgeTekst))
		{
			filtreredeKunder = new List<Kunde>(); // Tøm listen, hvis søgefeltet er tomt
		}
		else
		{
			var søgetekstLower = søgeTekst.ToLower();
			filtreredeKunder = kunder.Where(k =>
			k.KundeId.ToString().Contains(søgeTekst) ||
			(!string.IsNullOrEmpty(k.Navn) && k.Navn.ToLower().Contains(søgeTekst.ToLower())) ||
			k.Telefonnummer?.ToString().Contains(søgeTekst) == true

			).ToList();

		}
	}
	private async Task SøgKunderAsync()
	{
		try
		{
			if (string.IsNullOrWhiteSpace(søgeTekst))
			{
				filtreredeKunder = new List<Kunde>(); // Tøm listen, hvis søgefeltet er tomt
			}
			else
			{
				var response = await Http.GetFromJsonAsync<List<Kunde>>($"api/Kunde/searchmany?søgeTekst={Uri.EscapeDataString(søgeTekst)}");
				filtreredeKunder = response ?? new List<Kunde>();
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Fejl under søgning: {ex.Message}");
			filtreredeKunder = new List<Kunde>(); // Hvis der opstår en fejl
		}
	}
	private async Task VælgKunde(int kundeId)
	{
		valgtKundeId = kundeId;

		// Hent kunden fra filtreredeKunder eller fra API'et, hvis nødvendigt
		valgtKunde = filtreredeKunder.FirstOrDefault(k => k.KundeId == kundeId);

		if (valgtKunde == null)
		{
			valgtKunde = await Http.GetFromJsonAsync<Kunde>($"api/Kunde/{kundeId}");
		}

		søgeTekst = ""; // Ryd søgeteksten
		filtreredeKunder.Clear(); // Tøm resultatlisten
		await HentScootereForKunde(kundeId); // Hent scootere relateret til kunden
		StateHasChanged(); // Tving UI-opdatering
	}
	private void RydValgtKunde()
	{
		valgtKunde = null;
		valgtKundeId = 0;
		filtreredeKunder.Clear();
		StateHasChanged(); // Tving UI-opdatering
	}

	private async Task HentScootereForKunde(int kundeId)
	{
		try
		{
			var response = await Http.GetFromJsonAsync<List<KundeScooter>>($"api/KundeScooter/{kundeId}/scootere");
			kundeScootere = response ?? new List<KundeScooter>();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Fejl ved hentning af scootere: {ex.Message}");
			kundeScootere = new List<KundeScooter>();
		}
	}

	private double BeregnLejeAftaleTotalPris()
	{
		if (lejeaftale == null || !lejeaftale.StartDato.HasValue || !lejeaftale.SlutDato.HasValue || lejeaftale.DagligLeje <= 0)
		{
			return 0; // Returner 0, hvis noget mangler
		}

		var dage = (lejeaftale.SlutDato.Value - lejeaftale.StartDato.Value).Days;
		var kilometerOmkostning = lejeaftale.KortKilometer.HasValue
		? lejeaftale.KilometerPris * lejeaftale.KortKilometer.Value
		: 0;
		var forsikringsPris = lejeaftale.ForsikringsPris * dage;

		return (lejeaftale.DagligLeje * dage) + kilometerOmkostning + forsikringsPris;
	}


	private void AktivTabSkift(string tab) => aktivTab = tab;



	private void TilføjYdelse(Ydelse ydelse)
	{
		if (!valgteOrdreYdelser.Any(oy => oy.Ydelse.YdelseId == ydelse.YdelseId))
		{
			valgteOrdreYdelser.Add(new OrdreYdelse
				{
					Ydelse = ydelse,
					AftaltPris = null,
					Dato = DateTime.Now
				});
		}
	}

	private void FjernYdelse(OrdreYdelse ordreydelse)
	{
		valgteOrdreYdelser.Remove(ordreydelse);
	}

	private void VisBekræftelse()
	{
		visBekræftelsesModal = true;
	}

	private void LukBekræftelsesModal()
	{
		visBekræftelsesModal = false;
	}

	private async Task BekræftOprettelse()
	{
		visBekræftelsesModal = false;

		if (valgtKundeId == 0 || (!valgteOrdreYdelser.Any() && lejeaftale == null))
		{
			Console.WriteLine("Vælg en kunde og tilføj mindst én ydelse eller udfyld lejeaftaledetaljer.");
			return;
		}

		// Tilføj kun lejeaftale, hvis der er en scooter valgt
		if (valgtLejeScooterId.HasValue)
		{
			lejeaftale.LejeScooterId = valgtLejeScooterId.Value;
		}
		else
		{
			lejeaftale = null; // Ingen lejeaftale
		}

		var ordreDTO = new CreateOrdreDto
			{
				KundeId = valgtKundeId,
				Dato = DateTime.Now,
				TotalPris = TotalPris,
				OrdreYdelser = valgteOrdreYdelser.Select(oy => new CreateOrdreYdelseDto
				{
					YdelseId = oy.Ydelse.YdelseId,
					AftaltPris = oy.AftaltPris,
					Dato = DateTime.Now,
					ScooterId = oy.ScooterId
				}).ToList(),
				LejeAftale = lejeaftale,
				OrdreProdukter = valgteProdukter.Select(p => new CreateOrdreProduktDto
				{
					ProduktId = p.ProduktId,
					Antal = p.Antal ?? 1,
					Pris = p.Pris ?? 0
				}).ToList() // Tilføj produkterne
			};

		try
		{
			var response = await Http.PostAsJsonAsync("api/ordre", ordreDTO);
			if (response.IsSuccessStatusCode)
			{
				visSuccesBesked = true;
				NulstilOrdreData(); // Nulstil data
			}
			else
			{
				Console.WriteLine("Fejl ved oprettelse af ordre.");
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"En undtagelse opstod: {ex.Message}");
		}
	}

	}

